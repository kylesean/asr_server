# ğŸ¤ VAD ASR è¯­éŸ³è¯†åˆ«æœåŠ¡å™¨

åŸºäº Sherpa-ONNX çš„é«˜æ€§èƒ½è¯­éŸ³è¯†åˆ«æœåŠ¡ï¼Œæ”¯æŒå®æ—¶VADï¼ˆè¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼‰ã€å¤šè¯­è¨€è¯†åˆ«å’Œå£°çº¹è¯†åˆ«ã€‚

**æ”¯æŒæ¨¡å‹ï¼š** SenseVoiceå’ŒFun-ASR-Nano

## âœ¨ ç‰¹æ€§
- å®æ—¶å¤šè¯­è¨€è¯­éŸ³è¯†åˆ«ï¼ˆä¸­/è‹±/æ—¥/éŸ©/ç²¤ç­‰ï¼‰
- VADæ™ºèƒ½åˆ†æ®µï¼Œè‡ªåŠ¨è¿‡æ»¤é™éŸ³
- å£°çº¹è¯†åˆ«
- WebSocket å®æ—¶é€šä¿¡ï¼Œä½å»¶è¿Ÿ
- å¥åº·æ£€æŸ¥ã€çŠ¶æ€ç›‘æ§ã€ä¼˜é›…å…³é—­

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šDocker éƒ¨ç½²ï¼ˆæ¨èï¼‰

ä½¿ç”¨ 8-bit é‡åŒ–æ¨¡å‹ï¼Œé•œåƒä½“ç§¯å°ï¼Œé¦–æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨ä» ModelScope ä¸‹è½½æ¨¡å‹ã€‚

```bash
# æ„å»ºé•œåƒ
docker build -t asr_server .

# è¿è¡Œå®¹å™¨ï¼ˆVAD æ¨¡å‹å·²å†…ç½®ï¼ŒASR/Speaker æ¨¡å‹è‡ªåŠ¨ä¸‹è½½ï¼‰
docker run -d -p 8000:8000 --name asr_server asr_server
```

**ç‰¹ç‚¹ï¼š**
- æ¨¡å‹ï¼šFun-ASR-Nano-2512-8bitï¼ˆé‡åŒ–ç‰ˆï¼‰
- é•œåƒä½“ç§¯ï¼šçº¦ 200MB
- é¦–æ¬¡å¯åŠ¨ï¼šè‡ªåŠ¨ä¸‹è½½ ASR/Speaker æ¨¡å‹
- é€‚ç”¨åœºæ™¯ï¼šå¿«é€Ÿéƒ¨ç½²ã€èµ„æºå—é™ç¯å¢ƒ

#### ç«¯å£ä¸è®¿é—®
- æµ‹è¯•é¡µé¢: http://localhost:8000/
- å¥åº·æ£€æŸ¥: http://localhost:8000/health
- WebSocket: ws://localhost:8000/ws

---

### æ–¹å¼äºŒï¼šæœ¬åœ°å¼€å‘ï¼ˆæ¨èç»™å¼€å‘è€…ï¼‰

é€‚åˆéœ€è¦è°ƒè¯•ã€å¼€å‘æ–°åŠŸèƒ½æˆ–ä¸æƒ³ä½¿ç”¨ Docker çš„åœºæ™¯ã€‚

```bash
# 1. ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x dev.sh scripts/download_models.sh

# 2. ä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
./scripts/download_models.sh

# 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
./dev.sh
```

**ç‰¹ç‚¹ï¼š**
- ğŸ“ ä½¿ç”¨ç»Ÿä¸€é…ç½® (config.json)
- ğŸ”§ è‡ªåŠ¨é…ç½®åº“è·¯å¾„
- ğŸ” è‡ªåŠ¨æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
- âš¡ å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸€è‡´

**è¯¦ç»†æ–‡æ¡£**: [æœ¬åœ°å¼€å‘æŒ‡å—](docs/LOCAL_DEVELOPMENT.md)

---

### æ–¹å¼ä¸‰ï¼šæºç éƒ¨ç½²ï¼ˆè¿›é˜¶/å¼€å‘è€…ï¼‰

#### ç³»ç»Ÿè¦æ±‚
- Go 1.21+
- Linux/macOS/Windows
- å†…å­˜å»ºè®®4GB+

#### å®‰è£…ä¸ä¾èµ–å‡†å¤‡
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/bbeyondllove/asr_server.git
cd asr_server
# å®‰è£…Goä¾èµ–
go mod tidy
# å¤åˆ¶åŠ¨æ€åº“åˆ°ç³»ç»Ÿåº“ç›®å½•ï¼ˆLinuxï¼‰
cp lib/*.so /usr/lib/
cp lib/ten-vad/lib/Linux/x64/libten_vad.so /usr/lib/
# å®‰è£…C++è¿è¡Œæ—¶ä¾èµ–ï¼ˆå¦‚æœªå®‰è£…ï¼‰
sudo apt install libc++1
```

#### æ¨¡å‹å‡†å¤‡

æœ¬é¡¹ç›®æ”¯æŒä¸¤ç§ASRæ¨¡å‹ï¼Œå¯æ ¹æ®éœ€æ±‚é€‰æ‹©ï¼š

```bash
# ä¸‹è½½ SenseVoice æ¨¡å‹ï¼ˆå¤šè¯­è¨€ï¼šä¸­/è‹±/æ—¥/éŸ©/ç²¤ç­‰ï¼‰
mkdir -p models/asr/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17
git clone https://www.modelscope.cn/models/fengge2024/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17.git models/asr/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17

# æˆ–ä¸‹è½½ Fun-ASR-Nano æ¨¡å‹ï¼ˆ8bité‡åŒ–ç‰ˆï¼‰
mkdir -p models/asr/Fun-ASR-Nano-2512-8bit
git clone https://www.modelscope.cn/models/fengge2024/Fun-ASR-Nano-2512-8bit.git models/asr/Fun-ASR-Nano-2512-8bit

# ä¸‹è½½å£°çº¹è¯†åˆ«æ¨¡å‹
mkdir -p models/speaker
wget -O models/speaker/3dspeaker_speech_campplus_sv_zh_en_16k-common_advanced.onnx \
  https://www.modelscope.cn/models/fengge2024/3dspeaker_speech_campplus_sv_zh_en_16k-common_advanced.onnx/resolve/master/3dspeaker_speech_campplus_sv_zh_en_16k-common_advanced.onnx
```

**æ¨¡å‹é€‰æ‹©å»ºè®®ï¼š**
- **SenseVoice**: æ”¯æŒå¤šè¯­è¨€ï¼ˆä¸­/è‹±/æ—¥/éŸ©/ç²¤ï¼‰
- **Fun-ASR-Nano-8bit**: åŸºäºæ•°åƒä¸‡å°æ—¶çœŸå®è¯­éŸ³æ•°æ®è®­ç»ƒçš„ç«¯åˆ°ç«¯è¯­éŸ³è¯†åˆ«å¤§æ¨¡å‹ï¼Œæ”¯æŒä½å»¶è¿Ÿå®æ—¶è½¬å†™ï¼Œæ¶µç›–31ç§è¯­è¨€è¯†åˆ«åŠŸèƒ½ã€‚8bité‡åŒ–ç‰ˆä½“ç§¯å°ã€é€Ÿåº¦å¿«ï¼Œé€‚åˆèµ„æºå—é™ç¯å¢ƒ

**é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼š**
ä¸‹è½½åéœ€ä¿®æ”¹ `config.json` ä¸­çš„æ¨¡å‹è·¯å¾„ï¼š
```json
"recognition": {
  "model_path": "models/asr/Fun-ASR-Nano-2512-8bit/model.int8.onnx",  // æˆ– SenseVoice è·¯å¾„
  "tokens_path": "models/asr/Fun-ASR-Nano-2512-8bit/tokens.txt"
}
```

#### è¿è¡ŒæœåŠ¡
```bash
# é»˜è®¤é…ç½®å¯åŠ¨
go run main.go
# æˆ–ç¼–è¯‘åè¿è¡Œ
go build -o asr_server
./asr_server
```

#### è®¿é—®æµ‹è¯•
- æµ‹è¯•é¡µé¢: http://localhost:8000/
- å¥åº·æ£€æŸ¥: http://localhost:8000/health
- WebSocket: ws://localhost:8000/ws

---

## âš™ï¸ é…ç½®
è¯¦ç»†é…ç½®è¯·å‚è€ƒ `config.json` æ–‡ä»¶ã€‚

## ğŸ”Œ WebSocket API ç¤ºä¾‹
```javascript
const ws = new WebSocket('ws://localhost:8000/ws');
ws.onopen = () => ws.send(audioBuffer);
ws.onmessage = e => console.log('è¯†åˆ«ç»“æœ:', e.data);
```


## ğŸ›ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WebSocketå®¢æˆ·ç«¯   â”‚    â”‚   VADè¯­éŸ³æ´»åŠ¨æ£€æµ‹æ±    â”‚    â”‚   ASRè¯†åˆ«å™¨æ¨¡å—     â”‚
â”‚                    â”‚    â”‚                      â”‚    â”‚ (åŠ¨æ€new stream)   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  éŸ³é¢‘æµè¾“å…¥   â”‚â—„â”€â”¼â”€â”€â”€â–ºâ”‚  â”‚   VADå®ä¾‹    â”‚â—„â”€â”€â”¼â”€â”€â”€â–ºâ”‚  â”‚ Recognizer   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚                  â”‚
â”‚  â”‚ è¯†åˆ«ç»“æœæ¥æ”¶  â”‚  â”‚    â”‚  â”‚  ç¼“å†²é˜Ÿåˆ—    â”‚    â”‚    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¼šè¯ç®¡ç†å™¨       â”‚    â”‚   å£°çº¹è¯†åˆ«æ¨¡å—(å¯é€‰)  â”‚    â”‚   å¥åº·æ£€æŸ¥/ç›‘æ§    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚                    â”‚
â”‚  â”‚ è¿æ¥çŠ¶æ€ç®¡ç† â”‚  â”‚    â”‚  â”‚ è¯´è¯äººæ³¨å†Œ   â”‚    â”‚    â”‚  ç›‘æ§/çŠ¶æ€æ¥å£     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ èµ„æºåˆ†é…é‡Šæ”¾ â”‚  â”‚    â”‚  â”‚ å£°çº¹ç‰¹å¾æå– â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
 
## ğŸ›ï¸ å…³é”®å‚æ•°è¯´æ˜
| å‚æ•° | è¯´æ˜ | æ¨èå€¼ |
|------|------|--------|
| `vad.provider` | VADç±»å‹ï¼ˆsilero_vad æˆ– ten_vadï¼‰ | ten_vad |
| `vad.pool_size` | VADæ± å®ä¾‹æ•° | 200 |
| `vad.threshold` | VADæ£€æµ‹é˜ˆå€¼ | 0.5 |
| `vad.silero_vad.min_silence_duration` | silero_vad: æœ€å°é™éŸ³æ—¶é•¿ | 0.1 |
| `vad.silero_vad.min_speech_duration` | silero_vad: æœ€å°è¯­éŸ³æ—¶é•¿ | 0.25 |
| `vad.silero_vad.max_speech_duration` | silero_vad: æœ€å¤§è¯­éŸ³æ—¶é•¿ | 8.0 |
| `vad.silero_vad.window_size` | silero_vad: çª—å£å¤§å° | 512 |
| `vad.silero_vad.buffer_size_seconds` | silero_vad: ç¼“å†²åŒºæ—¶é•¿ | 10.0 |
| `vad.ten_vad.hop_size` | ten-vad: å¸§ç§» | 512 |
| `vad.ten_vad.min_speech_frames` | ten-vad: æœ€çŸ­è¯­éŸ³å¸§æ•° | 12 |
| `vad.ten_vad.max_silence_frames` | ten-vad: æœ€å¤§é™éŸ³å¸§æ•° | 5 |
| `recognition.num_threads` | ASRçº¿ç¨‹æ•° | 8-16 |
| `audio.sample_rate` | é‡‡æ ·ç‡ | 16000 |
| `server.port` | æœåŠ¡ç«¯å£ | 6000 |

### VAD é…ç½®ç¤ºä¾‹
```jsonc
"vad": {
  "provider": "ten_vad",      // é€‰æ‹© ten_vad æˆ– silero_vad
  "pool_size": 200,
  "threshold": 0.5,
  "silero_vad": {
    "model_path": "models/vad/silero_vad/silero_vad.onnx",
    "min_silence_duration": 0.1,
    "min_speech_duration": 0.25,
    "max_speech_duration": 8.0,
    "window_size": 512,
    "buffer_size_seconds": 10.0
  },
  "ten_vad": {
    "hop_size": 512,
    "min_speech_frames": 12,
    "max_silence_frames": 5
  }
}
```

## ğŸ§ª æµ‹è¯•ä¾‹å­
é¡¹ç›®è‡ªå¸¦ test/asr/ ç›®å½•ä¸‹çš„æµ‹è¯•è„šæœ¬ï¼š
- `audiofile_test.py`ï¼šå•æ–‡ä»¶è¯†åˆ«æµ‹è¯•ï¼Œæ”¯æŒå¤šè¯­ç§ wav æ–‡ä»¶ã€‚
- `stress_test.py`ï¼šå¹¶å‘å‹åŠ›æµ‹è¯•ï¼Œæ¨¡æ‹Ÿå¤šè¿æ¥å¹¶å‘è¯†åˆ«ã€‚

ç”¨æ³•ç¤ºä¾‹ï¼š
```bash
python stress_test.py --connections 100 --audio-per-connection 2
```
- `--connections`ï¼šå¹¶å‘è¿æ¥æ•°ï¼ˆå¦‚ 100 è¡¨ç¤ºåŒæ—¶æ¨¡æ‹Ÿ 100 ä¸ªå®¢æˆ·ç«¯ï¼‰
- `--audio-per-connection`ï¼šæ¯ä¸ªè¿æ¥è¦å‘é€çš„éŸ³é¢‘æ–‡ä»¶æ•°ï¼ˆå¦‚ 2 è¡¨ç¤ºæ¯ä¸ªè¿æ¥å„è‡ªå‘é€ 2 ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼‰

æœ¬ä¾‹å°†æ¨¡æ‹Ÿ 100 ä¸ªå¹¶å‘è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥å„è‡ªå‘é€ 2 ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼Œæ€»å…± 200 æ¬¡è¯†åˆ«è¯·æ±‚ã€‚

## ğŸ¤ è´¡çŒ®
æ¬¢è¿è´¡çŒ®ä»£ç ï¼æµç¨‹å¦‚ä¸‹ï¼š
1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®æ•´ä½“é‡‡ç”¨ MIT è®¸å¯è¯ã€‚ä½†è¯·æ³¨æ„ï¼š

- å¦‚æœä½ ä½¿ç”¨ ten-vad ç›¸å…³åŠŸèƒ½ï¼ˆå³ `vad.provider` è®¾ä¸º `ten_vad`ï¼‰ï¼Œéœ€éµå®ˆ [ten-vad çš„ License](https://github.com/ten-framework/ten-vad/blob/main/LICENSE)ã€‚
- å¦‚æœä»…ä½¿ç”¨ silero-vadï¼ˆå³ `vad.provider` è®¾ä¸º `silero_vad`ï¼‰ï¼Œå¯ç›´æ¥éµå¾ª MIT è®¸å¯è¯ã€‚

è¯·æ ¹æ®å®é™…ä½¿ç”¨çš„ VAD ç±»å‹ï¼Œéµå®ˆç›¸åº”çš„å¼€æºåè®®ã€‚

## ğŸ™ è‡´è°¢
- [Sherpa-ONNX](https://github.com/k2-fsa/sherpa-onnx) - æ ¸å¿ƒè¯­éŸ³è¯†åˆ«å¼•æ“
- [SenseVoice](https://github.com/FunAudioLLM/SenseVoice) - å¤šè¯­è¨€è¯­éŸ³è¯†åˆ«æ¨¡å‹
- [Fun-ASR](https://github.com/alibaba-damo-academy/FunASR) - è½»é‡çº§ä¸­æ–‡è¯­éŸ³è¯†åˆ«æ¨¡å‹
- [Silero VAD](https://github.com/snakers4/silero-vad) - è¯­éŸ³æ´»åŠ¨æ£€æµ‹æ¨¡å‹
- [ten-vad](https://github.com/zhenghuatan/ten-vad) - é«˜æ•ˆç«¯ç‚¹æ£€æµ‹ç®—æ³•

## ğŸ“ æ”¯æŒ
å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
- åˆ›å»º [Issue]
- å‘é€é‚®ä»¶åˆ°: bbeyond.llove@gmail.com